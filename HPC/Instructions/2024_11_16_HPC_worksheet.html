
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; MulQuaBio</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=01a0bdc2" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'HPC/Instructions/2024_11_16_HPC_worksheet';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="MulQuaBio - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="MulQuaBio - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Welcome to The Multilingual Quantitative Biologist!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Computing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Unix.html">UNIX and Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/ShellScripting.html">Shell scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Git.html">Version control with Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/LaTeX.html">Scientific documents with <span class="math notranslate nohighlight">\(\LaTeX\)</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Python.html">Biological Computing in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/R.html">Biological Computing in R</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ecological &amp; Evolutionary Modelling</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/MetabolicBasis.html">The Metabolic Basis of Ecology and Evolutionary dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Populations.html">Single Populations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Interactions.html">Species Interactions</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Basic Data Analyses and Statistics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../intro-Stats.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Data_R.html">Data Management and Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/ExpDesign.html">Experimental design and Data exploration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/t_F_tests.html">Basic hypothesis testing: <span class="math notranslate nohighlight">\(t\)</span> and <span class="math notranslate nohighlight">\(F\)</span> tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Regress.html">Linear Models: Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/ANOVA.html">Linear Models: Analysis of variance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/MulExpl.html">Linear Models: Multiple explanatory variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/MulExplInter.html">Linear Models: Multiple variables with interactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/ModelSimp.html">Model simplification</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced Data Analyses and Statistics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/GLMs.html">Generalised Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/NLLS.html">Model Fitting using Non-linear Least-squares</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-JupyIntro.html">Introduction to Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-Data-Python.html">Data analyses  with Python &amp; Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-Maths.html">Mathematical models in Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-MathsForBiologists/MathsForBiologists.html">Maths for Biologists</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-Databases.html">Databases <span class="tocSkip"></span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-NLLS-Python.html">Model fitting in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-MiniProj.html">The Computing Miniproject</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-Assessment.html">TMQB Coursework Assessment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Appendix-HighPerformanceComputing.html">Introduction to High-Performance Computing (HPC)</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/MulQuaBio/MQB" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/MulQuaBio/MQB/issues/new?title=Issue%20on%20page%20%2FHPC/Instructions/2024_11_16_HPC_worksheet.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/HPC/Instructions/2024_11_16_HPC_worksheet.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1><no title></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="simple visible nav section-nav flex-column">
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><strong>High Performance Computing Programming Exercises</strong></p>
<p>18<sup>th</sup> – 22<sup>nd</sup> November 2024 (last updated
16<sup>th</sup> November 2024)</p>
<p>James Rosindell (<a class="reference external" href="mailto:j&#46;rosindell&#37;&#52;&#48;imperial&#46;ac&#46;uk">j<span>&#46;</span>rosindell<span>&#64;</span>imperial<span>&#46;</span>ac<span>&#46;</span>uk</a>)</p>
<p><strong>Deadline and handing in</strong></p>
<ul class="simple">
<li><p>Keep all your code in GitHub.</p></li>
<li><p>You will hand in your files as part of your mini project in spring
2025.</p></li>
<li><p>Refer to the course guidebook for exact dates.</p></li>
</ul>
<p><strong>What to hand in</strong></p>
<p>Please hand in the following files, changing the placeholder “abc123” to
your own username:</p>
<ul class="simple">
<li><p>abc123_HPC_2024_neutral_cluster.R (based on pro-forma)</p></li>
<li><p>abc123_HPC_2024_demographic_cluster.R (based on pro-forma)</p></li>
<li><p>abc123_HPC_2024_main.R (based on pro-forma)</p></li>
<li><p>all your graphs as .png files</p></li>
<li><p>your shell script (.sh) files for running on the cluster</p></li>
<li><p>.e and .o files generated by the cluster for your simulation runs</p></li>
<li><p>.rda output files saved from the cluster for your simulation runs,
.rda file from your output in Q20, and .rda results from any
Challenge questions which take a long time to produce</p></li>
<li><p>optional additional .rda files or .R files that get sourced by your
other files</p></li>
</ul>
<p><strong>Important notes about the hand in</strong></p>
<p>Some aspects of the marking will be automatic, or assisted by automated
systems, so it’s important you pay attention to the specifications and
follow them precisely.</p>
<ul class="simple">
<li><p>Do not use packages (other than ggplot2, if you wish) – nothing else
is needed.</p></li>
<li><p>All files should be in one folder (no sub folders please).</p></li>
<li><p>All challenge questions should be in the one main.R file you hand
in.</p></li>
<li><p>Any slow computations for challenge questions (&gt;1 min) should be
pre-calculated and stored in a separate .rda file so that I can run
the main function quickly.</p></li>
<li><p>Create new functions whenever you wish, e.g., to create the .rda
files, to abstract parts of the code, etc. However, <strong>the function
names in the pro forma must remain as defined</strong> (as these will be
called by name in the auto marking script).</p></li>
<li><p><strong>Never ever</strong> clear the workspace in your main file. This is
because your main file is treated like a library of functions that
can be sourced and used, either by your own experimentation to check
it works, or by my marking code, or by a file to be run on HPC.</p></li>
<li><p>Always <strong>include your own username and name files properly using
lower case</strong>.</p></li>
<li><p>If I run the source command on your main.R file it should run very
quickly without error and load all the functions into memory so that
they can be tested – <strong>it should not actually run the functions</strong> or
perform any other tasks (such as plotting or printing).</p></li>
<li><p>Don’t try to change the working directory in the code or do anything
clever with the paths that would not work on another machine. Assume
that the working directory will be directory that contains all your
files with no subfolders.</p>
<ul>
<li><p>You <strong>can</strong> source(“abc123_HPC_2024_main.R”)</p></li>
<li><p>You <strong>cannot</strong> source(“Documents/HPC
course/abc123_HPC_2024_main.R)</p></li>
</ul>
</li>
</ul>
<p><strong>Please tell me if you spot errors in this document so that I can
correct them.</strong></p>
<p><strong>Section one: Stochastic demographic population model</strong></p>
<p>We will describe a population using a population state vector called
<em><strong>state</strong></em> which contains the number of individuals in each life stage.
So if <em><strong>state</strong></em> was <em><strong>{ 1 0 3 }</strong></em> then there would be three life
stages, with one individual in stage 1, none in stage 2, and three in
stage 3 (so a total population size of four divided into 3 distinct life
stages).</p>
<p>You will be given code in an R file <em><strong>demographic.R</strong></em> which carries
out a deterministic simulation of a population with life states. Don’t
worry about how the underlying model works (we will look at this in a
later lecture). This exercise is about using simulation code locally and
on an HPC system and you may need to do this in future with code that
you didn’t write yourself. Later in this worksheet you will write a
different simulation of your own and that you will also get to run on
the cluster.</p>
<p>You will have access to a function called <em><strong>deterministic_simulation</strong></em>
which takes the inputs <em><strong>initial_state</strong></em>, <em><strong>simulation_length</strong></em> and
<em><strong>projection_matrix</strong></em>. The <em><strong>initial_state</strong></em> is a vector describing
the starting state of your simulation, the <em><strong>simulation_length</strong></em> is
the amount of time that the simulation should run for and the
<em><strong>projection_matrix</strong></em> describes how the simulation will work. The
function will return a vector of length (simulation_length+1)
representing a time series of the total population size, so that the
[n+1]<sup>th</sup> entry of the vector is the total population size at
time step n (and the first entry is the initial population size, at time
step 0). Important note: your <em><strong>projection_matrix</strong></em> should be a square
and its number of rows and number of columns should be equal to the
length of your <em><strong>initial_state</strong></em> vector.</p>
<ol class="arabic simple">
<li><p>(Preliminary question, yes, we’re starting at zero and not at one)</p></li>
</ol>
<blockquote>
<div><p>Write a function called state_initialise_adult which creates a state
vector of length num_stages representing a population of size
initial_size, all of which are in the adult life stage (the final life
stage). [Hint: The rep function].</p>
<p>Write a function called state_initialise_spread which creates a state
vector of length num_stages representing a population of size
initial_size. This time, the population should be spread out across
the life stages as evenly as possible. If the population size is not
divisible by the number of life stages, then allocate the remaining
individuals starting from the youngest life stage first. For example,
state_initialise_spread(num_stages=3, initial_size=8) should return {
3 3 2 }. [Hint: The floor function may be useful].</p>
<p>[3 marks]</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>Write a function in the file with name ending <em><strong>main.R</strong></em> called
<em><strong>question_1</strong></em> (with no inputs) which carries out a deterministic
simulation with two different initial conditions and saves a graph
comparing the population size time series. You will need to source
the code from the provided <em><strong>demographic.R</strong></em> file. Run the
deterministic model for a species with four life stages, with a
simulation length of 24, and projection matrix as given at the end
of this question, using the following two initial conditions: a
population of 100 adults (final life stage), and a population of 100
individuals spread across the four life stages. Create and save the
plot <em><strong>question_1.png</strong></em> which should show the population size time
series for both simulations using different-coloured lines. The
function should output as text the answer to the question “<em>Explain
how the initial distribution of the population in different life
stages affects the initial and eventual population growth.</em>”</p></li>
</ol>
<p>For your simulation, the <em><strong>projection_matrix</strong></em> to be used is defined
as follows:</p>
<p>growth_matrix &lt;- matrix(c(0.1, 0.0, 0.0, 0.0,</p>
<p>0.5, 0.4, 0.0, 0.0,</p>
<p>0.0, 0.4, 0.7, 0.0,</p>
<p>0.0, 0.0, 0.25, 0.4),</p>
<blockquote>
<div><p>nrow=4, ncol=4, byrow=T)</p>
</div></blockquote>
<p>Which looks like:</p>
<p>[,1] [,2] [,3] [,4]</p>
<p>[1,] 0.1 0.0 0.0 0.0</p>
<p>[2,] 0.5 0.4 0.0 0.0</p>
<p>[3,] 0.0 0.4 0.7 0.0</p>
<p>[4,] 0.0 0.0 0.2 0.4</p>
<p>reproduction_matrix &lt;- matrix(c(0.0, 0.0, 0.0, 2.6,</p>
<p>0.0, 0.0, 0.0, 0.0,</p>
<p>0.0, 0.0, 0.0, 0.0,</p>
<p>0.0, 0.0, 0.0, 0.0),</p>
<blockquote>
<div><p>nrow=4, ncol=4, byrow=T)</p>
</div></blockquote>
<p>projection_matrix = reproduction_matrix + growth_matrix</p>
<p>Note that using the `matrix` function in R, the default is to fill out
the matrix column by column. This may be counter-intuitive since in
English we write from left to right. By specifying `byrow=T` we are
instructing the `matrix` function that we want to fill out the matrix
row by row instead.</p>
<p>[4 marks for correct code, results and graph]</p>
<p>We will now look at a stochastic version of the same model, the
principles of the simulation are very similar but because of the
stochasticity the result you get back will not be the same each time you
run the simulation.</p>
<p>You will have access to a function called <em><strong>stochastic_simulation</strong></em>
which takes the inputs <em><strong>initial_state</strong></em>, <em><strong>growth_matrix,
reproduction_matrix, clutch_distribution</strong></em>, and
<em><strong>simulation_length.</strong></em> <em><strong>initial_state</strong></em> and <em><strong>simulation_length</strong></em>
have the same meaning as your <em><strong>deterministic_simulation</strong></em> function.
All the other parameters describe the inner workings of the model. The
function returns a vector of length <em><strong>simulation_length+1</strong></em> which is
the time series of the population size, just as in
<em><strong>deterministic_simulation.</strong></em></p>
<ol class="arabic simple">
<li><p>Write a function in the file with name ending <em><strong>main.R</strong></em> called
<em><strong>question_2</strong></em> (with no inputs), which applies the
<em><strong>stochastic_simulation</strong></em> with the same two sets of initial
conditions and other parameters as given to the deterministic model
in Question 1, <em><strong>growth_matrix, reproduction_matrix</strong></em> are now used
separately but are as defined above, the <em><strong>clutch_distribution</strong></em>
is as provided at the end of the question. Create and save a plot
called <em><strong>question_2.png</strong></em> which plots the population size time
series for both simulations using different-coloured lines. Your
function should output a plain text answer to the question “<em>How
does the smoothness of the earlier deterministic simulations compare
with these stochastic simulations? Explain why this is the case.”</em></p></li>
</ol>
<p>clutch_distribution &lt;- c(0.06,0.08,0.13,0.15,0.16,0.18,0.15,0.06,0.03)</p>
<p>[3 marks]</p>
<p>Now you’re going to run your stochastic simulation many times, using the
HPC cluster.</p>
<p>Important note: don’t panic! This question is a lot harder than the
previous two but you can do it, just take a small step at a time to
break down the problem of writing the code.</p>
<ol class="arabic simple">
<li><p>Write an R script in the file with name ending
<em><strong>demographic_cluster.R</strong></em> which, when sourced, will carry out
simulations on the HPC cluster. There will be 100 cluster runs with
four different initial conditions – so a quarter of the simulations
should be assigned to each initial condition. Each cluster run will
perform the simulation 150 times (so in total there will be 15,000
simulations spread across your cluster nodes).</p></li>
</ol>
<p>In all simulations, there are four life stages. The projection matrix
and clutch distribution are those used previously in Question 2, but
this time, run the simulation for 120 steps (which is ten years since
our time scale is months). The four initial conditions are (1) a large
population of 100 adults, (2) a small population of 10 adults, (3) a
large population of 100 individuals spread across the life stages, and
(4) a small population of 10 individuals spread across the life stages.</p>
<p>Your code will need to achieve, in this order:</p>
<ul class="simple">
<li><p>Clear the workspace and turn off graphics.</p></li>
<li><p>Load all the functions you need by sourcing the provided
demographic.R file</p></li>
<li><p>Read in the job number from the cluster. To do this, your code
should include a new variable <em><strong>iter</strong></em> and should start with the
line:</p></li>
</ul>
<blockquote>
<div><p>iter &lt;- as.numeric(Sys.getenv(“PBS_ARRAY_INDEX”))</p>
</div></blockquote>
<ul class="simple">
<li><p>Control the random number seeds so that each parallel simulation
takes place with a different seed. Your function should therefore
set the random number seed as <em><strong>iter</strong></em> so that each parallel
simulation has a unique random seed*.*</p></li>
<li><p>In each parallel run, select the initial condition to be used.
Ensure that 25 of the parallel simulations are allocated to each of
the initial conditions.</p></li>
<li><p>Create a variable which is the filename to store your results. The
end of the filename should be the number <em><strong>iter</strong></em> to ensure that
simulation files do not overwrite one another on the cluster.</p></li>
<li><p>Initialise a list which will contain the results of your 150
simulations.</p></li>
<li><p>Call the <em><strong>stochastic_simulation</strong></em> function to do the appropriate
simulation 150 times, appending the output to the results list, and
then save the results list.</p></li>
</ul>
<blockquote>
<div><p>[10 marks for correct code]</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>Write a shell script for running your code on the cluster. You need
to decide what wall time to give the cluster. I recommend you check
how long it takes to run one of the large initial population size
simulations on your own computer and then use that to inform how
long you should give a cluster node to do this 150 times.</p></li>
</ol>
<p>Use sftp and ssh to set your jobs running on the cluster as instructed
during the lecture (and see lecture notes). Then test on the cluster
with a job number (<em><strong>iter</strong></em>) of 1, 2, 3 only (use -J 1-3 as in the
lecture notes). Finally, run the full set of jobs to the cluster (-J
4-100) if the first three came out OK.</p>
<p>[10 marks for all output files (.rda, .e, and .o) and shell script
code]</p>
<p>The next step is to write two R functions to plot the results from your
cluster run. These functions will read in and process your results,
assuming that all of the necessary .rda files are in the current working
directory. If your cluster simulations are still running I suggest skip
ahead and make progress on section 2 while you wait.</p>
<ol class="arabic simple">
<li><p>Write a function called <em><strong>question_5</strong></em> (with no inputs) that
should produce and save a bar graph showing the proportion of
stochastic simulations which resulted in extinction for each initial
condition. This function needs to work out how many extinctions
occurred for each initial condition, and divide that by the total
number of simulations to compute the proportion of simulations
resulting in extinction. It should then plot a bar graph with
initial condition on the x-axis and proportion of populations which
went extinct on the y-axis, and should save this bar graph as
<em><strong>question_5.png</strong></em>. The x-axis labels should be interpretable,
e.g. “adults, large population” rather than “initial condition 1”.
Your function should then return a plain text answer to the question
“<em>Which population was most likely to go extinct? Explain why this
is the case.”</em>. [Hint: If a population went extinct, its final
population size would be equal to 0].</p></li>
</ol>
<p>[8 marks for correct code, graph and results]</p>
<ol class="arabic simple">
<li><p>Write a function called <em><strong>question_6</strong></em> (with no inputs) that
should produce and save a line graph showing the deviation of the
average population trend of the stochastic model from the
corresponding demographic model. <strong>Only analyse the simulation files
for initial conditions 3 and 4</strong> (i.e., we will only look at the
small mixed and large mixed populations). For each of these two
initial conditions you will need to:</p></li>
</ol>
<ul>
<li><p>Identify the appropriate <em><strong>population_size</strong></em> results for this</p>
<blockquote>
<div><p>initial condition.</p>
</div></blockquote>
</li>
<li><p>Compute the mean population size (which we will refer to as the</p>
<blockquote>
<div><p>“population trend”) at each time step across all simulations with
this initial condition. [Hint: For a given initial condition, the
population trend can be calculated as the sum of all the
population size time series vectors divided by the number of
simulations.]</p>
</div></blockquote>
</li>
<li><p>Compute the population size time series produced by the</p>
<blockquote>
<div><p>deterministic model <em><strong>deterministic_simulation</strong></em> (using the same
projection matrix and simulation length as your stochastic
simulations).</p>
</div></blockquote>
</li>
<li><p>Compute the deviation of the stochastic model from the deterministic</p>
<blockquote>
<div><p>model by dividing the stochastic population trend vector by the
deterministic population size vector (obtaining, at each point in
time, the value of the average population size from the stochastic
model divided by the value of the deterministic population size).
Note that if this value is 1, that means that the deterministic
population size is the same as the average behaviour of the
stochastic model.</p>
</div></blockquote>
</li>
<li><p>Plot on the same graph as panels the deviation of the stochastic</p>
<blockquote>
<div><p>model from the deterministic model for each initial condition
(ensure that each line is identifiable).</p>
</div></blockquote>
</li>
<li><p>Save this figure as <em><strong>question_6.png</strong></em>. Give the graph an</p>
<blockquote>
<div><p>interpretable title.</p>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><p>The function should return the plain text answer to the question “<em>For
which initial condition is it more appropriate to approximate the
‘average’ behaviour of this stochastic system with a deterministic
model? Explain why.</em>”</p>
<p>[10 marks for correct code, graphs and results]</p>
<p>Challenge Question A: Important: do not attempt unless you’ve finished
all the non challenge questions, including those in section two. Write
an R function called <em><strong>Challenge_A</strong></em> with no inputs. When run, this
function will go through all the data produced by the cluster
simulations and output a data frame called <em><strong>population_size_df</strong></em>.
This is a data frame containing <em><strong>(simulation_size+1)*150*100</strong></em>
rows; a long-form data frame where each row represents a specific time
point for a specific simulation run. The columns of this data frame
should be <em><strong>simulation_number</strong></em> (such that each individual
simulation has a unique identifier - it doesn’t necessarily need to be
the job number), <em><strong>initial_condition</strong></em> (either “small adult”, “large
adult”, “small mixed”, or “large mixed” as appropriate),
<em><strong>time_step</strong></em> (from 0 to <em><strong>simulation_size</strong></em>) and, finally,
<em><strong>population_size</strong></em>, which is the corresponding population size from
this stochastic simulation at this time step. Use your data frame to
produce and save a graph called <em><strong>Challenge_A.png</strong></em> which should
plot all the population size time series against time in a single
graph, using the package <em>ggplot2</em>. Use <em><strong>geom_line</strong></em>, set
<em><strong>aes(x=time_step, y=population_size, group=simulation_number,
colour=initial_state)</strong></em>, and set <em><strong>alpha=0.1</strong></em> (modify alpha if
needed) to produce faint, but visible, overlapping lines.</p>
</div></blockquote>
<p><strong>Section Two: Individual-based ecological neutral theory simulation</strong></p>
<p>These questions build on one another, step by step, so that by the end
you will have produced your own individual-based ecological neutral
theory simulation code in R.</p>
<p>You will store the state of your simulated system as a vector of
individuals called <em><strong>community</strong></em>. Each entry in the vector is a number
that tells you the species of the individual in that position. For
example, if <em><strong>community = c(1,1,1,3,1)</strong></em> then four individuals in the
community are species 1, and one individual is species 3.</p>
<ol class="arabic simple">
<li><p>You will need to know the species richness of your system, so write
a function <em><strong>species_richness</strong></em> to measure the species richness of
the input <em><strong>community</strong></em> which is a vector. For example,
<em><strong>species_richness(c(1,4,4,5,1,6,1))</strong></em> should return 4. (Hint: the
‘unique’ command).</p></li>
</ol>
<p>[2 marks]</p>
<ol class="arabic simple">
<li><p>Write a function <em><strong>init_community_max</strong></em> to generate an initial
state for your simulation community with the maximum possible number
of species for the community of size given by the input number
variable <em><strong>size</strong></em>. This means that every individual in the
community will be a different species to all the others (Hint: the
‘seq’ command).</p></li>
</ol>
<p>[1 mark]</p>
<ol class="arabic simple">
<li><p>In this type of simulation, it’s important to consider the effect of
the initial condition. Write another function
<em><strong>init_community_min</strong></em> to generate an alternative initial state
for your simulation. Again, the output will be a community of size
given by the input variable <em><strong>size.</strong></em> This is monodominance of one
species with a total number of individuals given by <em><strong>size</strong></em>.</p></li>
</ol>
<p>[1 mark]</p>
<p>~ Test your code ~</p>
<p>For any reasonable value of x,</p>
<ul class="simple">
<li><p>species_richness(init_community_min(x)) should always return 1, and</p></li>
<li><p>species_richness(init_community_max(x)) should always return x.</p></li>
</ul>
<ol class="arabic simple">
<li><p>Write a function <em><strong>choose_two</strong></em>. This function should first choose
a random integer (whole number) according to a uniform distribution
between 1 and the input <em><strong>max_value</strong></em>, inclusive of the endpoints.
It should also choose a second random integer between 1 and
<em><strong>max_value</strong></em> but not equal to the first number. The numbers
should be returned as a vector of length 2. So <em><strong>choose_two(4)</strong></em>
might return the vector {3 4}, or one of a number of other vectors
with equal probability. (Hint: the ‘sample’ command).</p></li>
</ol>
<p>[2 marks]</p>
<ol class="arabic simple">
<li><p>Write a function <em><strong>neutral_step</strong></em> to perform a single step of a
simple neutral model simulation, without speciation, on a community
vector <em><strong>community</strong></em>. You will need to (randomly, based on a
uniform distribution) pick an individual to die and another to
reproduce and fill the gap left by the death; they should not be the
same individual (though could be of the same species). For example,
<em><strong>neutral_step(c(1,2))</strong></em> would return { 1 1 } or { 2 2 } with
equal probability (either the first individual dies and is replaced
by the second’s offspring, or the second individual dies and is
replaced by the first’s offspring). (Hint: call your function
<em><strong>choose_two</strong></em>, thinking of the numbers returned as indexes of
your <em><strong>community</strong></em> vector where the individuals’ species are
stored).</p></li>
</ol>
<p>[2 marks]</p>
<ol class="arabic simple">
<li><p>Write a function <em><strong>neutral_generation</strong></em> to simulate several
<em><strong>neutral_step</strong></em>s on a community so that a generation has passed.
A generation is the amount of time expected between birth and
reproduction (not the time between birth and death, which is longer
if generations overlap). If the community consists of x individuals,
then x/2 individual neutral steps will correspond to a complete
generation for the taxa being simulated. If x is not an even number,
choose at random whether to round up or down to the nearest whole
number to determine how many neutral steps will correspond to a
generation. For example, if there are 10 individuals in the
community then 5 neutral steps mean 5 births and 5 deaths (so one
generation). Your function should return a vector giving the state
of the <em><strong>community</strong></em> after a generation has passed. (Hint:
<em><strong>neutral_step</strong></em> and a loop).</p></li>
</ol>
<p>[2 marks]</p>
<ol class="arabic simple">
<li><p>Write a function <em><strong>neutral_time_series</strong></em> that will do a neutral
theory simulation and return a time series of species richness in
the system. The function should have two inputs: <em><strong>community</strong></em>
(the initial condition community vector) and <em><strong>duration</strong></em> (the
number of generations you want to run the simulation for). The
function should return a vector giving the species richness at each
generation of the simulation run, starting with the initial
condition species richness. For example,
<em><strong>neutral_time_series(community = init_community_max(7), duration =
20)</strong></em> should return a vector containing a time series vector of
length 21, with the first value being 7 (the species richness of the
initial condition community). (Hint: <em><strong>neutral_generation</strong></em> and a
loop).</p></li>
</ol>
<p>[2 marks]</p>
<ol class="arabic simple">
<li><p>Write a function <em><strong>question_14</strong></em> to plot and save a time series
graph of your neutral model simulation from an initial condition of
maximal diversity in a system size of 100 individuals. Run the
simulation for 200 generations. The function should require no
inputs to run and should return a plain text answer to the following
question: <em>“What state will the system always converge to if you
wait long enough? Why is this?”</em>. Your plot should be saved as
<em><strong>question_14.png</strong></em> (Hint: use <em><strong>neutral_time_series</strong></em> and the
plot command. You can use the plot saving code given in the
pro-forma. Check the plot .png looks OK before you move on!)</p></li>
</ol>
<p>[3 marks]</p>
<ol class="arabic simple">
<li><p>Write a new function <em><strong>neutral_step_speciation</strong></em> which will
perform a step of a neutral model with speciation. In each time
step, with probability <em><strong>speciation_rate</strong></em> speciation will replace
a dead individual with a new species, and otherwise (with
probability <span class="math notranslate nohighlight">\(1 - \ \)</span><em><strong>speciation_rate</strong>)</em> the dead individual is
replaced with the offspring of another individual, as before in
<em><strong>neutral_step</strong></em>. You should make <em><strong>speciation_rate</strong></em> be an
input parameter (between 0 and 1) in your function. For example,
<em><strong>neutral_step_speciation(c(1,1,2), speciation_rate = 0.2)</strong></em>
should behave like <em><strong>neutral_step(c(1,1,2))</strong></em> with probability
0.8, and with probability 0.2 it should instead be equally likely to
return { 1 1 n }, { 1 n 2 }, { n 1 2 }, with n in each case being a
species number different to any other species number in the current
community, here anything other than 1 or 2. (Hint: be careful to
make sure that any new species really has a unique number assigned
that is currently not used by any other species in the community.)</p></li>
</ol>
<p>[3 marks]</p>
<ol class="arabic simple">
<li><p>Make a new function <em><strong>neutral_generation_speciation</strong></em> which uses a
neutral simulation with speciation and advances an initial community
one generation according to the rules of the model. (This is similar
to what <em><strong>neutral_generation</strong></em> achieves but with the new
speciation rule). The new function should have two inputs: the
initial <em><strong>community</strong></em> vector and the <em><strong>speciation_rate</strong></em>. It
should return the state of the community at the end of all the steps
of simulation which make up the generation.</p></li>
</ol>
<p>[1 mark]</p>
<ol class="arabic simple">
<li><p>Make a new function <em><strong>neutral_time_series_speciation</strong></em> which uses
our neutral simulation with speciation and advances a number of
generations given by <em><strong>duration</strong></em>. (This is similar to what
<em><strong>neutral_time_series</strong></em> achieves but using our speciation model).
This function should have three input parameters; the same two as in
<em><strong>neutral_time_series</strong></em>, and the additional input
<em><strong>speciation_rate</strong></em>. The return should be in the same format as
<em><strong>neutral_time_series</strong></em>; a time series vector containing the
species richness at each generation, with the first entry of the
vector being the species richness of the initial condition
community).</p></li>
</ol>
<p>[1 mark]</p>
<ol class="arabic simple">
<li><p>Write a function <em><strong>question_18</strong></em> to perform a neutral theory
simulation with speciation, plot species richness against time, and
save this plot (similar to in question 14). Use a speciation rate of
0.1, a community size of 100, and run your simulations for 200
generations. Plot two time series on the same axes in different
colours showing how the simulation progresses from two different
initial states given by <em><strong>init_community_max</strong></em> and
<em><strong>init_community_min</strong></em>. Your function <em><strong>question_18</strong></em> should
require no inputs to run, should display and save the plot as
<em><strong>question_18.png</strong></em>, and also return a plain text answer to the
following question <em>“Explain what you found from this plot about the
effect of initial conditions. Why does the neutral model simulation
give you those particular results?”</em></p></li>
</ol>
<p>[4 marks]</p>
<ol class="arabic simple">
<li><p>You are going to study the species abundance distribution of these
neutral simulations. First, you need to write a function
<em><strong>species_abundance</strong></em> to tell you what the abundances of all the
species are in the system <em><strong>community</strong></em>. It should return a vector
containing the number of individuals of each species, in descending
order of abundance. For example,</p></li>
</ol>
<blockquote>
<div><p><em><strong>species_abundance(c(1,5,3,6,5,6,1,1))</strong></em> should return { 3 2 2 1}.</p>
<p>This is because there are 3 of species “1”, 1 of species “3”, 2 of
species “5”, and 2 of species “6” (and these four abundances are
presented in descending order). (Hint: the ‘table’ and ‘sort’
commands.)</p>
</div></blockquote>
<p>[3 marks]</p>
<ol class="arabic simple">
<li><p>Write a function called <em><strong>octaves</strong></em> to bin the abundances of
species (e.g., the output of the <em><strong>species_abundance</strong></em> function)
into what would be called ‘octave classes’. The first value of the
returned vector should tell you how many species have an abundance
of only 1, the second value of the returned vector should tell you
how many species have an abundance of either 2 or 3, and in general
the n<sup>th</sup> value of the returned vector sholould tell you
how many species have an abundance greater than or equal to
2<sup>n-1</sup> but strictly less than 2<sup>n</sup>. For example,
in the 6<sup>th</sup> element of the octave vector will be the
number of species in octave class 6. This is the number of species
with an abundance of <u>greater than or equal to</u> 2<sup>5</sup>
(which is 32) but <u>less than</u> 2<sup>6</sup> (which is 64).
(Hint: the ‘log’, ‘floor’, and ‘tabulate’ functions may be useful.
If you’re not sure what to do, try writing out a table of abundances
and the octave that they fall in, then look for a way to generate
this in R using the functions mentioned in this hint.)</p></li>
</ol>
<p>[3 marks]</p>
<p>These simulations are stochastic, so you will need to average the result
from a number of independent readings to get an idea of the overall
behaviour of the system. You will find that octave vectors are not
always the same length; for example, if there were 100 individuals all
of different species, then the octave vector would be { 100 } (vector of
length 1), while if these individuals were all the same species, the
octave vector would be { 0 0 0 0 0 0 1 } (vector of length 7). In such
cases, R will not allow you to simply add them – or, worse, will add
them in a way that you do not intend, and give you the wrong answer. The
next question is to help you solve this problem.</p>
<ol class="arabic simple">
<li><p>Write a function <em><strong>sum_vect(x,y)</strong></em> which accepts two vectors as
inputs, <em><strong>x</strong></em> and <em><strong>y</strong></em>, and returns their sum, after filling
whichever of the vectors that is shorter with zeros to bring it up
to the correct length. For example,
<em><strong>sum_vect(c(1,3),c(1,0,5,2))</strong></em> should return { 2 3 5 2 } by
adding { 1 3 0 0 } and { 1 0 5 2 }. (Hint: the ‘length’ function and
‘if’ command).</p></li>
</ol>
<p>[2 marks]</p>
<ol class="arabic simple">
<li><p>Write a function <em><strong>question_22</strong></em> to run two neutral model
simulations and save bar plots of the species abundance
distributions. Use the same parameters as in question 18 for a
“burn-in” period of 200 generations, again running the simulation
from both initial conditions. After the burn-in period, record the
species abundance octave vector. Continue the simulation from where
you left off for a further 2000 generations, recording the species
abundance octave vector every 20 generations. Produce a bar chart
plot of the mean species abundance distribution (as octaves) by
calculating a mean for each bar of the octaves plot from all the
recorded octave vectors. Perform this for both initial conditions
(minimum and maximum initial species richness). Save these plots as
two panels in <em><strong>question_22.png</strong></em> using the sample code included
in the function. Your function <em><strong>question_22</strong></em> should require no
inputs to run and should return a plain text answer to the following
question: <em>“Does the initial condition of the system matter? Why is
this?”</em></p></li>
</ol>
<p>[4 marks]</p>
<blockquote>
<div><p>Challenge Question B: Write a function <em><strong>Challenge_B</strong></em> to plot the
mean species richness as a function of time (measured in generations)
across many repeat simulations using the same parameters as in
question 22. Add a 97.2% confidence interval on the species richness
at each point in time. Repeat this for both initial conditions
(minimum and maximum initial species richness) shown in different
series on the same plot. Your function should have no inputs and
should save your plot as <em><strong>Challenge_B.png</strong></em>. Estimate the number of
generations needed for the system to reach dynamic equilibrium and
output this in a full sentence as a plain text return.</p>
<p>Challenge Question C: Write a function <em><strong>Challenge_C</strong></em> to plot and
save a graph called <em><strong>Challenge_C.png</strong></em> showing many averaged time
series for a whole range of different initial species richnesses. In
each initial community state, each individual should be equally likely
to take any species identity. (Hint: It’s OK here and elsewhere to
create additional functions of your own to help streamline your code
or make your working cleaner).</p>
</div></blockquote>
<p>You are going to be running a much larger simulation of the same type
that you conducted for your answer to question 22 and with more repeat
readings. To do this requires use of high performance computing (HPC)
and some adaptations of your R code.</p>
<ol class="arabic">
<li><p>Create a function <em><strong>neutral_cluster_run</strong></em> which accepts seven
input parameters: <em><strong>speciation rate, size, wall_time,
interval_rich, interval_oct, burn_in_generations</strong></em> and
<em><strong>output_file_name</strong></em>. This function should:</p>
<ul>
<li><p>Start with a community with size given by the input <em><strong>size</strong></em>
and with minimal diversity (species richness).</p></li>
<li><p>Apply neutral generations with a speciation rate given by
<em><strong>speciation_rate</strong></em> for a predefined amount of computing time
<em><strong>wall_time</strong></em> measured in <u>minutes</u>. (Hint: if you’re not
sure where to start, get a timer working on its own first; use
the ‘proc.time’ command for this.)</p></li>
<li><p>Store the species richness at intervals of <em><strong>interval_rich</strong></em>,
but only during the burn-in period, which is measured in
generations. After the number of generations exceeds the burn-in
time <em><strong>burn_in_generations</strong></em>, stop recording the species
richness. The species richness should be recorded in a vector
called <em><strong>time_series</strong></em> (Hint: use a vector to store the
species richnesses and use ‘%%’ to help detect when to do this.
It’s probably easier to have one main simulation loop and use
‘’if’ statements inside it to determine whether the simulation
is burning in or not. It’s worth noting that the point of this
is to create a time series; a series of species richness values
across time. However, you should <em>not</em> use
<em>neutral_time_series_speciation()</em> because that function doesn’t
return the community state at the end so cannot be used to
continue the simulation.)</p></li>
<li><p>For the entire simulation, until the simulation runs out of time
(as determined by <em><strong>wall_time</strong></em>), you should record the
species abundances as octaves every <em><strong>interval_oc</strong></em>
generations. (Hint: use ‘list’.)</p></li>
<li><p>You should save your simulation results in a file with name</p>
<blockquote>
<div><p>given by the input <em><strong>output_file_name</strong></em> including the
following data: the <em><strong>time_series</strong></em> of species richness
recorded during the <em><strong>burn_in_generations</strong></em>, the list of
species abundance octaves <em><strong>abundance_list</strong></em>, the state of
the <em><strong>community</strong></em> at the end of the simulation, the total
amount of time <em><strong>total_time</strong></em> actually consumed on the
simulation, and all seven of the input parameters for the
function (except for the <em><strong>output_file_name</strong></em> – we don’t
need to store a reminder of what the file name is inside the
file itself!). (Hint: use the ‘save’ command, and don’t call
your outputs by the same names as your functions – otherwise
the functions and not the outputs will be saved.)</p>
</div></blockquote>
</li>
<li><p>Test your code locally before proceeding further using the same</p>
<blockquote>
<div><p>parameters from question 22 and a short time limit of 5 to 10
minutes. For example:</p>
</div></blockquote>
</li>
</ul>
</li>
</ol>
<blockquote>
<div><p>neutral_cluster_run(speciation_rate=0.1, size=100, wall_time=10,
interval_rich=1, interval_oct=10, burn_in_generations=200,
output_file_name=”my_test_file_1.rda”)</p>
<p>This should run for 10 minutes and return nothing but save a file
called <em>“my_test_file_1.rda”</em> which you can then open in R and look at
the data to check you’ve got everything you expected.</p>
<p>[6 marks]</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>Use a new R file for running simulations on the cluster, based on
the provided pro forma. As you code, press “source” every time you
run it because that’s what will happen on the cluster. Now you’re
ready to write lines of code in your new R file which will source
and use the functions you have written. It should be that when you
run the file using the source command you will get the simulation
you want. You will not be writing another function, but rather
writing R code in the file to be run. The code needs to achieve, in
this order:</p>
<ul class="simple">
<li><p>Clear the workspace and turn off graphics.</p></li>
<li><p>Load all the functions you need by sourcing your main.R file
(and any other necessary .R files).</p></li>
<li><p>Read in the job number from the cluster. To do this, your code
should include a new variable <em><strong>iter</strong></em> and should start with
the line:</p></li>
</ul>
</li>
</ol>
<blockquote>
<div><p>iter &lt;- as.numeric(Sys.getenv(“PBS_ARRAY_INDEX”))</p>
<p>However, for testing on your own machine this will not work, so write
the line and then comment it out and instead set <em><strong>iter</strong></em> yourself
to different numbers for local testing. The last thing to do before
you run your code on the cluster is then to comment out your “local
testing” line and uncomment the real job number line.</p>
</div></blockquote>
<ul class="simple">
<li><p>Control the random number seeds so that each parallel simulation
takes place with a different seed. If you run two simulations with
the same seed, you will get the same answer regardless of the fact
that it’s a stochastic simulation (since computers are only
<em>pseudo-<em>random). Your function should therefore set the random
number seed as <em><strong>iter</strong></em> so that each parallel simulation has a
unique random seed</em>.</em></p></li>
<li><p>In each parallel simulation, select the community size being used.
The community sizes to be simulated are 500, 1000, 2500, and 5000.
Ensure that 25 of the parallel simulations are allocated to each of
these community sizes. For example, you could set <em><strong>size=500</strong></em>
when <em><strong>iter</strong></em> is between 1 and 25 (inclusive), and so on.</p></li>
<li><p>Your speciation rate will be the same for all your simulations.
However, each person will be given a different speciation rate,
handed out separately to this workbook.</p></li>
<li><p>Create a variable which is the filename to store your results. The
end of the filename should be the number <em><strong>iter</strong></em> to ensure that
simulation files do not overwrite one another on the cluster. (Hint:
use the ‘paste’ command.)</p></li>
<li><p>Call the <em><strong>neutral_cluster_run</strong></em> function, which will actually do
the simulation and save the results. Use <em><strong>interval_rich=1</strong></em>,
<em><strong>interval_oct=size/10</strong></em>, and <em><strong>burn_in_generations=8*size</strong></em>.</p></li>
<li><p>Use a time limit of 12 hours for all your jobs (give your code a
time of 11.5 hours and tell the cluster 12 hours just in case).</p></li>
</ul>
<blockquote>
<div><p>[6 marks for the correct code]</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>Write a shell script for running your code on the cluster. Use sftp
and ssh to set your jobs running on the cluster as instructed during
the lecture (and see lecture notes). Then test on the cluster with a
job number (<em><strong>iter</strong></em>) of 1, 2, 3 only (use -J 1-3 as in the
lecture notes). Finally, run the full set of jobs to the cluster (-J
4-100) if the first three came out OK.</p></li>
</ol>
<p>[10 marks for all output files (.rda, .e, and .o) and shell script
code]</p>
<ol class="arabic simple">
<li><p>Plot the results from your cluster run. While your job is running on
the cluster, you can write an R function
<em><strong>process_neutral_cluster_results</strong></em> to read in and process the
output files. Your code should read in all your output files (assume
them to be sitting there in your current working directory). It
should only use data of the abundance octaves after the burn-in time
is up. The function should calculate a mean value across all the
saved (post-burn-in) data for each abundance octave and for each
community <em><strong>size</strong></em>. (I.e., averaging not just across time but also
across all the 25 simulations of each community size). It should
save all the summarised data in a new .rda file as a list of four
vectors corresponding to the octave outputs that plot the four bar
graphs. The vectors should appear in the list in increasing
community <em><strong>size</strong></em> order (<em><strong>size=500</strong></em> first, then 100, etc.)
(Hint: use the ‘load’ function on your .rda files and use
<em><strong>sum_vect</strong></em>). Next, write an R function
<em><strong>plot_neutral_cluster_results</strong></em> that should provide and save four
bar graphs in a multi-panel graph (one bar graph for each community
<em><strong>size</strong></em>) each showing a mean species abundance octave result from
all simulation runs of that size and the list of data it plotted.
This function should save the multi-panel graph as
<em><strong>plot_neutral_cluster_results.png</strong></em>.</p></li>
</ol>
<p>[10 marks for your graphs and correct results]</p>
<p>Challenge Question D: Write a function <em><strong>Challenge_D</strong></em> to plot a graph
of mean species richness against simulation generation and use it to
inform you more precisely how long should have been allowed as a burn-in
period for different values of <em><strong>size</strong></em>. This function would also need
to read in your simulation data and process it, as in
<em><strong>process_neutral_cluster_results</strong></em>. Your function should save the
graphs as <em><strong>Challenge_D.png</strong></em>.</p>
<p>Challenge Question E: Write a function <em><strong>Challenge_E</strong></em> to conduct
further simulations of the same system using coalescence (see the pseudo
code below). Check that your results from the cluster agree with those
from coalescence (plot and save a graph in the file
<em><strong>Challenge_E.png</strong></em> to show this) and compare the speed of the two
approaches. Return plain text to answer the question <em>“How many CPU
hours were used on the coalescence simulation and how many on the
cluster to do an equivalent set of simulations? Why were the coalescence
simulations so much faster?”</em></p>
<p>Pseudo code for Challenge E, to get a coalescence simulation of the
neutral model from question 22 as a function of community <em><strong>size</strong></em>
(<span class="math notranslate nohighlight">\(J\)</span>) and <em><strong>speciation_rate</strong></em> (v<span class="math notranslate nohighlight">\()\)</span>.</p>
<ol class="arabic simple">
<li><p>Initialise a vector <em><strong>lineages</strong></em> of length <span class="math notranslate nohighlight">\(J\)</span> with <span class="math notranslate nohighlight">\(1\)</span> in every
entry.</p></li>
<li><p>Initialise an empty vector <em><strong>abundances</strong></em> (of length 0).</p></li>
<li><p>Initialise a number <span class="math notranslate nohighlight">\(N = J\)</span>.</p></li>
<li><p>Calculate <span class="math notranslate nohighlight">\(\theta\)</span>, where <span class="math notranslate nohighlight">\(\theta = v\frac{J - 1}{1 - v}\)</span>.</p></li>
<li><p>Choose an index <em><strong>j</strong></em> for the vector <em><strong>lineages</strong></em> at random
according to a uniform distribution.</p></li>
<li><p>Pick a random (decimal, not integer) number <em><strong>randnum</strong></em> between 0
and 1 (with a uniform distribution).</p></li>
<li><p>If <em><strong>randnum</strong></em>
<span class="math notranslate nohighlight">\(\mathbf{&lt;}\frac{\mathbf{\theta}}{\mathbf{\theta + N - 1}}\)</span>, append
<em><strong>lineages[j]</strong></em> to the vector <em><strong>abundances</strong></em>.</p></li>
<li><p>If <em><strong>randnum</strong></em>
<span class="math notranslate nohighlight">\(\mathbf{\geq}\frac{\mathbf{\theta}}{\mathbf{\theta + N - 1}}\)</span>,
choose another index <em><strong>i</strong></em> for the vector <em><strong>lineages</strong></em> at
random, but do not allow <em><strong>i=j</strong></em>. Then set <em><strong>lineages[i] &lt;-
lineages[i] + lineages[j]</strong></em>.</p></li>
<li><p>Remove <em><strong>lineages[j]</strong></em> from <em><strong>lineages</strong></em> so that the
<em><strong>lineages</strong></em> vector is now one shorter.</p></li>
<li><p>Decrease <span class="math notranslate nohighlight">\(N\)</span> by one so that <span class="math notranslate nohighlight">\(N\)</span> still gives the length of the
<em><strong>lineages</strong></em> vector.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(N &gt; 1\)</span>, repeat the code again from (e) to here.</p></li>
<li><p>Once <span class="math notranslate nohighlight">\(N = 1\)</span>, add the only element left in <em><strong>lineages</strong></em> to the end
of <em><strong>abundances</strong></em>.</p></li>
<li><p>END: A vector of simulated species abundances is stored in
<em><strong>abundances</strong></em>.</p></li>
</ol>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./HPC/Instructions"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="simple visible nav section-nav flex-column">
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By MulQuaBio collective!
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>